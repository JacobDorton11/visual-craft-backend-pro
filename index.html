<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visual Craft Photography</title>
  <meta name="theme-color" content="#000000" />
  <link rel="icon" href="/192.png" />
  <link rel="apple-touch-icon" href="/512.png" />
  <style>
    :root { --splash-url: url('/images/splash-bg.jpg'); }
    html, body, #root { height: 100%; margin: 0; }
    body { font-family: Georgia, Times, serif; color:#111; background:#fff; }
    .diag { position: fixed; top: 6px; left: 6px; font: 12px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#222; z-index: 9999; }
    .card { background: rgba(255,255,255,0.55); border: 2px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); }
    .btn { display:inline-block; border:none; border-radius:12px; padding:14px 22px; min-height:48px; font-size:16px; cursor:pointer }
    .btn-dark { background:#1a1a1a; color:#fff }
    .btn-mid  { background:#4d4d4d; color:#fff }
    .btn-ghost{ background:transparent; color:#1a1a1a; border:2px solid #1a1a1a }
    .pill { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.55); padding:10px 18px; border-radius:12px; border:2px solid rgba(255,255,255,0.25); font-size:14px; color:#1a1a1a; text-decoration:none }
    a { color: inherit; }
  </style>
</head>
<body>
  <div class="diag" id="diag">Diagnostics loading…</div>
  <div id="root"></div>

  <!-- React + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script>
    // --- diagnostics (keep visible while we test) ---
    (function(){
      const ok = (x) => x ? 'OK' : 'MISSING';
      const hasReact = !!window.React;
      const hasReactDOM = !!window.ReactDOM;
      const hasRouter = true; // we'll provide our own router below
      const imgPing = new Image();
      imgPing.onload = () => document.getElementById('diag').textContent =
        `React: ${ok(hasReact)} ReactDOM: ${ok(hasReactDOM)} Router: ${ok(hasRouter)} Image: OK`;
      imgPing.onerror = () => document.getElementById('diag').textContent =
        `React: ${ok(hasReact)} ReactDOM: ${ok(hasReactDOM)} Router: ${ok(hasRouter)} Image: MISSING`;
      imgPing.src = '/images/splash-bg.jpg';
    })();
  </script>

  <script>
    // =========================================================
    // Minimal Hash Router (no external dependency)
    // =========================================================
    const RouterContext = React.createContext(null);

    function parsePath(path) {
      // normalize leading '#'
      const p = path || '';
      return p.startsWith('#') ? p.slice(1) : p;
    }

    function makeMatcher(pattern) {
      // patterns like /confirm/:code
      const keys = [];
      const rx = new RegExp('^' + pattern.replace(/\/:([^/]+)/g, (_,k)=>{ keys.push(k); return '/([^/]+)'; }) + '$');
      return (pathname) => {
        const m = pathname.match(rx);
        if (!m) return null;
        const params = {};
        keys.forEach((k,i)=> params[k] = decodeURIComponent(m[i+1]));
        return params;
      };
    }

    function Router({ routes, children }) {
      const [pathname, setPathname] = React.useState(()=> parsePath(location.hash) || '/');

      React.useEffect(()=>{
        const onHash = ()=> setPathname(parsePath(location.hash) || '/');
        window.addEventListener('hashchange', onHash);
        if (!location.hash) location.hash = '#/'; // default
        return ()=> window.removeEventListener('hashchange', onHash);
      }, []);

      const navigate = React.useCallback((to, { replace=false }={})=>{
        const hash = to.startsWith('#') ? to : '#'+to;
        if (replace) location.replace(hash); else location.hash = hash;
      }, []);

      const match = React.useMemo(()=>{
        for (const r of routes) {
          const params = r.matcher(pathname);
          if (params) return { element: r.element, params };
        }
        return { element: React.createElement('div', null, 'Not found'), params:{} };
      }, [pathname, routes]);

      const ctx = React.useMemo(()=>({ pathname, params: match.params, navigate }), [pathname, match.params, navigate]);

      return React.createElement(RouterContext.Provider, { value: ctx },
        children ? children : match.element
      );
    }

    function useLocation() {
      return React.useContext(RouterContext);
    }
    function useNavigate() {
      return React.useContext(RouterContext).navigate;
    }
    function Link({ to, children, style, className }) {
      const href = to.startsWith('#') ? to : '#'+to;
      return React.createElement('a', { href, style, className }, children);
    }
    function Navigate({ to, replace }) {
      const nav = useNavigate();
      React.useEffect(()=> { nav(to, { replace }); }, [to, replace, nav]);
      return null;
    }

    // =========================================================
    // App code (adapted to use the tiny router above)
    // =========================================================
    const { useState, useMemo, useEffect, useContext, createContext } = React;
    const { createRoot } = ReactDOM;

    // ---- Auth / RBAC (owner seeded) ----
    const AuthCtx = createContext(null);
    const seedOwner = { id:"u_owner", email:"jacob.dorton@gmail.com", name:"Jacob Dorton", roles:["owner"] };
    function AuthProvider({children}) {
      const [user,setUser] = useState(seedOwner);
      const login = (as="client") => {
        if (as==="owner") setUser(seedOwner);
        else if (as==="admin") setUser({ id:"u_admin", email:"admin@visualcraft", name:"Admin", roles:["admin"] });
        else setUser({ id:"u_client", email:"client@example.com", name:"Client", roles:["client"] });
      };
      const logout = () => setUser(null);
      const hasRole = (r) => !!user?.roles?.includes(r);
      return React.createElement(AuthCtx.Provider, { value:{user,login,logout,hasRole} }, children);
    }
    function RequireRole({ anyOf, children }) {
      const { user } = React.useContext(AuthCtx);
      if (!user) return React.createElement(Navigate, { to:"/" , replace:true });
      if (anyOf && !anyOf.some(r => user.roles?.includes(r))) return React.createElement(Navigate, { to:"/", replace:true });
      return children;
    }

    // ---- UI atoms ----
    const Button = ({children, onClick, variant="dark", style}) =>
      React.createElement('button', {
        onClick,
        className:`btn ${variant==="dark"?"btn-dark":variant==="mid"?"btn-mid":variant==="ghost"?"btn-ghost":""}`,
        style
      }, children);

    const Card = ({style, children}) =>
      React.createElement('div', { className:'card', style }, children);

    const PillButton = ({label, to}) =>
      React.createElement(Link, { to, className:'pill' }, label);

    // ---- Pages ----
    function NavBar(){
      const { user, logout, hasRole } = React.useContext(AuthCtx);
      return React.createElement('div', { style:{
        display:'flex',justifyContent:'space-between',alignItems:'center',
        padding:'12px 16px',borderBottom:'1px solid #eee',position:'sticky',top:0,background:'#fff',zIndex:10
      }},
        React.createElement(Link, { to:'/', style:{textDecoration:'none', color:'#111'}}, React.createElement('strong', null, 'Visual Craft')),
        React.createElement('div', { style:{display:'flex',gap:12,alignItems:'center'}},
          user && React.createElement(Link,{to:'/book'},'Book'),
          user && React.createElement(Link,{to:'/download'},'Download'),
          user && (hasRole('owner')||hasRole('admin')) && React.createElement(Link,{to:'/admin'},'Admin'),
          user && React.createElement('span',{style:{color:'#4d4d4d'}}, user.email),
          user ? React.createElement(Button,{variant:'ghost', onClick:logout}, 'Log out') : null
        )
      );
    }

    function Section({title, children}) {
      return React.createElement('div',{ style:{ maxWidth:900, margin:'0 auto', padding:'16px 16px 24px'}},
        React.createElement('h2',{ style:{ fontSize:28, margin:'8px 0 12px'}}, title),
        React.createElement(Card,{ style:{ background:'#fff', border:'1px solid #e5e5e5'}}, children)
      );
    }

    function SplashLogin(){
      const { login } = React.useContext(AuthCtx);
      return React.createElement('div',{ style:{
        minHeight:'100vh', backgroundImage:'var(--splash-url)', backgroundSize:'cover', backgroundPosition:'center', position:'relative'
      }},
        React.createElement(Card, { style:{ position:'absolute', top:'44%', left:'50%', transform:'translate(-50%,-50%)',
          width:'min(92vw,700px)', padding:8 } },
          React.createElement('h1',{ style:{ fontSize:'clamp(26px,4vw,36px)', margin:0, color:'#1a1a1a', textAlign:'center', lineHeight:1.15 } }, 'Visual Craft Photography'),
          React.createElement('p',{ style:{ textAlign:'center', color:'#4d4d4d', marginTop:8 }}, 'Sign in or create an account'),
          React.createElement('div',{ style:{ display:'grid', gap:12, marginTop:24 }},
            React.createElement(Button,{variant:'dark', onClick:()=>login('client')}, 'Log in'),
            React.createElement(Button,{variant:'mid', onClick:()=>login('client')}, 'Create account'),
            React.createElement('div',{ style:{ display:'flex', gap:8, justifyContent:'center', marginTop:6 }},
              React.createElement(Button,{variant:'ghost', onClick:()=>login('owner')}, 'Owner demo'),
              React.createElement(Button,{variant:'ghost', onClick:()=>login('admin')}, 'Admin demo')
            )
          )
        ),
        React.createElement(PillButton,{label:'Share', to:'/download'})
      );
    }

    function BookingFlow(){
      const [step,setStep] = React.useState(0);
      const [form,setForm] = React.useState({ listingType:null, pkg:null, place:null, slot:null });

      const listingTypes = [
        { key:'residential', label:'Residential Listing' },
        { key:'land', label:'Land Listing' },
        { key:'commercial', label:'Commercial Listing' },
      ];
      const packages = [
        { key:'silver', label:'Silver Package', minutes:60, desc:'Professional photography of interior and exterior of property.' },
        { key:'gold', label:'Gold Package', minutes:90, desc:'Professional photography of interior and exterior of property, and a Video Walkthrough Tour.' },
        { key:'platinum', label:'Platinum Package', minutes:120, desc:'Professional photography of interior and exterior of property. A Video Walkthrough Tour, Drone Video and Photography, as well as floor plan illustrations.' },
      ];

      function TypeStep(){
        return React.createElement(Section,{title:'Choose a Listing Type'},
          React.createElement('div',{style:{display:'grid',gap:12}},
            ...listingTypes.map(t =>
              React.createElement('button',{ key:t.key, onClick:()=>{ setForm(f=>({...f, listingType:t.key})); setStep(1); },
                style:{ textAlign:'left', padding:16, borderRadius:12, border:'1px solid #e5e5e5', background:'#fff' }}, t.label)
            )
          )
        );
      }
      function PackageStep(){
        return React.createElement(Section,{title:'Select a Package'},
          React.createElement('div',{style:{display:'grid',gap:12}},
            ...packages.map(p =>
              React.createElement('button',{ key:p.key, onClick:()=>{ setForm(f=>({...f, pkg:p})); setStep(2); },
                style:{ textAlign:'left', padding:16, borderRadius:12, border:'1px solid #e5e5e5', background:'#fff' }},
                React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',gap:8}},
                  React.createElement('div',null,
                    React.createElement('div',{style:{fontSize:18}}, p.label),
                    React.createElement('div',{style:{color:'#4d4d4d',marginTop:4}}, p.desc)
                  ),
                  React.createElement('div',{style:{fontSize:14,color:'#4d4d4d'}}, `${p.minutes} min`)
                )
              )
            )
          )
        );
      }
      const mockPlaces = [
        { label: "123 Main St, Asheville, NC", lat: 35.5951, lng: -82.5515 },
        { label: "18 Biltmore Ave, Asheville, NC", lat: 35.5938, lng: -82.5517 },
        { label: "1 Page Ave, Asheville, NC", lat: 35.5959, lng: -82.5553 },
      ];
      const [q,setQ] = React.useState("");
      const results = React.useMemo(()=> mockPlaces.filter(p => p.label.toLowerCase().includes(q.toLowerCase())), [q]);

      function AddressStep(){
        return React.createElement(Section,{title:'Property Address'},
          React.createElement('div',{style:{display:'grid',gap:12}},
            React.createElement('input',{ placeholder:'Search address (Google Maps)…', value:q, onChange:e=>setQ(e.target.value),
              style:{ padding:14, borderRadius:12, border:'1px solid #e5e5e5' } }),
            React.createElement('div',{style:{display:'grid',gap:8}},
              ...results.map(r =>
                React.createElement('button',{ key:r.label, onClick:()=>{ setForm(f=>({...f, place:r})); setStep(3); },
                  style:{ textAlign:'left', padding:12, borderRadius:12, border:'1px solid #e5e5e5', background:'#fff' }}, r.label)
              )
            )
          )
        );
      }
      function TimeStep(){
        const slots = ['9:00 AM','10:00 AM','11:00 AM','1:00 PM','2:00 PM','3:00 PM'];
        return React.createElement(Section,{title:'Select a Time'},
          React.createElement('div',{style:{display:'grid',gap:12}},
            ...slots.map(t =>
              React.createElement('button',{ key:t, onClick:()=>{ setForm(f=>({...f, slot:{ label:t }})); setStep(4); },
                style:{ textAlign:'left', padding:14, borderRadius:12, border:'1px solid #e5e5e5', background:'#fff', display:'flex', justifyContent:'space-between' }},
                React.createElement('span',null,t),
                React.createElement('span',{style:{color:'#4d4d4d'}}, form.pkg?.minutes ? `${form.pkg.minutes} min` : '')
              )
            )
          )
        );
      }
      const makeCode = ()=> {
        const s4 = () => Math.random().toString(36).slice(2, 6).toUpperCase();
        const y = new Date().toISOString().slice(0,10).replace(/-/g,"");
        return `VCP-${y}-${s4()}`;
      };
      const nav = useNavigate();
      function ReviewStep(){
        return React.createElement(Section,{title:'Review & Confirm'},
          React.createElement('div',{style:{display:'grid',gap:12}},
            React.createElement('div',null, `Listing Type: ${form.listingType||''}`),
            React.createElement('div',null, `Package: ${form.pkg?.label||''}`),
            React.createElement('div',null, `Address: ${form.place?.label||''}`),
            React.createElement('div',null, `Time: ${form.slot?.label||''}`),
            React.createElement('div',{style:{display:'flex',gap:12,marginTop:8}},
              React.createElement(Button,{variant:'dark', onClick:()=>nav('/confirm/'+makeCode())}, 'Confirm Appointment'),
              React.createElement(Button,{variant:'mid', onClick:()=>setStep(3)}, 'Back')
            )
          )
        );
      }

      function Stepper({current}) {
        const steps = ['Type','Package','Address','Time','Review'];
        return React.createElement('div',{style:{display:'flex',gap:12,justifyContent:'center',alignItems:'center',margin:'16px auto 8px',maxWidth:720}},
          ...steps.map((s,i)=>{
            const done = i<current, active = i===current;
            return React.createElement('div',{ key:s, style:{
              padding:'8px 12px', borderRadius:999, border:'1px solid #e5e5e5',
              fontSize:14, background: active?'#111':done?'#4d4d4d':'#fff', color:(active||done)?'#fff':'#111'
            }}, s)
          })
        );
      }

      return React.createElement('div', {style:{paddingBottom:32}},
        React.createElement(Stepper,{current:step}),
        step===0 && React.createElement(TypeStep),
        step===1 && React.createElement(PackageStep),
        step===2 && React.createElement(AddressStep),
        step===3 && React.createElement(TimeStep),
        step===4 && React.createElement(ReviewStep)
      );
    }

    function ConfirmPage(){
      const { pathname } = useLocation();
      const code = pathname.split('/').pop();
      return React.createElement(Section,{title:'Appointment Confirmed'},
        React.createElement('div',{style:{textAlign:'center'}},
          React.createElement('div',{style:{fontSize:28, marginBottom:8}}, 'Confirmation #'),
          React.createElement('div',{style:{fontSize:22, marginBottom:16}}, code),
          React.createElement('div',{style:{color:'#4d4d4d', marginBottom:16, maxWidth:560, marginInline:'auto', lineHeight:1.35}},
            'A confirmation email with an .ics invite will be sent. It includes a one-tap Reschedule link.'
          ),
          React.createElement('div',{style:{display:'flex',justifyContent:'center',gap:12,flexWrap:'wrap',maxWidth:560,margin:'0 auto'}},
            React.createElement(Button,{variant:'mid', style:{minWidth:260}}, 'Add to Calendar (ICS)'),
            React.createElement(Button,{variant:'dark', style:{minWidth:260}}, 'Manage Booking')
          )
        )
      );
    }

    function DownloadPage(){
      return React.createElement(Section,{title:'Download / Install'},
        React.createElement('div',{style:{display:'grid',gap:12}},
          React.createElement('div',null, React.createElement('strong',null,'PWA (Web App): '),
            'On iPhone Safari: Share → Add to Home Screen. On Android Chrome: ⋮ → Install App.'),
          React.createElement('div',null, React.createElement(Link,{to:'/'}, 'Back to login'))
        )
      );
    }

    function AdminIndex(){
      return React.createElement(Section,{title:'Admin'},
        React.createElement('div',{style:{display:'flex',gap:12,flexWrap:'wrap'}},
          React.createElement(Link,{to:'/admin/today'}, React.createElement(Button,{variant:'dark'}, 'Day Routing Preview')),
          React.createElement(Link,{to:'/admin/new-booking'}, React.createElement(Button,{variant:'mid'}, 'New Booking'))
        )
      );
    }
    function AdminToday(){
      const jobs = [
        { id:1, at:'09:00', address:'123 Main St, Asheville, NC', pkg:'Silver' },
        { id:2, at:'12:00', address:'18 Biltmore Ave, Asheville, NC', pkg:'Gold' },
        { id:3, at:'15:00', address:'1 Page Ave, Asheville, NC', pkg:'Platinum' },
      ];
      return React.createElement(Section,{title:'Today • Route Preview'},
        React.createElement('ol',{style:{margin:0,paddingLeft:20}},
          ...jobs.map((j,i)=>React.createElement('li',{key:j.id,style:{margin:'12px 0'}},
            React.createElement('strong',{style:{marginRight:8}}, j.at),' ',
            `${j.pkg} — ${j.address}`,
            i<jobs.length-1 ? React.createElement('span',{style:{color:'#4d4d4d'}}, ' • Next leg: ~15–25 min') : null
          ))
        )
      );
    }

    // ------------ assemble routes ------------
    function AppShell(){
      const routes = [
        { path: '/',               element: React.createElement(SplashLogin) },
        { path: '/book',           element: React.createElement(BookingFlow) },
        { path: '/confirm/:code',  element: React.createElement(ConfirmPage) },
        { path: '/download',       element: React.createElement(DownloadPage) },
        { path: '/admin',          element: React.createElement(RequireRole,{anyOf:['owner','admin']}, React.createElement(AdminIndex)) },
        { path: '/admin/today',    element: React.createElement(RequireRole,{anyOf:['owner','admin']}, React.createElement(AdminToday)) },
      ].map(r => ({ ...r, matcher: makeMatcher(r.path) }));

      return React.createElement(AuthProvider,null,
        React.createElement(NavBar),
        React.createElement(Router,{ routes })
      );
    }

    createRoot(document.getElementById('root')).render(React.createElement(AppShell));
  </script>
</body>
</html>
