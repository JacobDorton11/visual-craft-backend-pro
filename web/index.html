<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Visual Craft Photography</title>
    <link rel="manifest" href="/public/manifest.json"/>
    <meta name="theme-color" content="#000000"/>
    <link rel="stylesheet" href="/styles.css"/>

    <style>
      html,body,#root{height:100%;margin:0}
      body{font-family:Georgia,Times,serif;background:#fff;color:#111}
      .splash-bg{min-height:100vh;background-image:url('/public/images/splash-bg.jpg');background-size:cover;background-position:center;position:relative}
      .center-card{position:absolute;top:44%;left:50%;transform:translate(-50%,-50%);width:min(92vw,700px);padding:8px}
      .diag{font:14px/1.4 Georgia,serif;background:#f7f7f7;border-bottom:1px solid #e5e5e5;padding:10px 12px;color:#333}
      .diag b{display:inline-block;min-width:140px}
      .ok{color:#0a0}.bad{color:#a00}
    </style>

    <!-- UMD libs (most robust) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.production.min.js"></script>
  </head>
  <body>
    <div class="diag" id="diag">Diagnostics loading…</div>
    <div id="root"><div style="padding:16px;color:#666">Loading Visual Craft…</div></div>

    <script>window.__API_BASE__ = "";</script>

    <!-- show runtime errors clearly -->
    <script>
      window.addEventListener('error', (e) => {
        const el = document.createElement('div');
        el.style.cssText = "position:fixed;left:0;right:0;bottom:0;background:#fee;border-top:1px solid #f99;color:#900;padding:8px;font:14px/1.4 Georgia,serif;z-index:99999;white-space:pre-wrap";
        el.textContent = "JS Error: " + (e.message || e.error) + (e.filename ? " @ " + e.filename + ":" + e.lineno : "");
        document.body.appendChild(el);
      });
    </script>

    <script>
      // ======== App (cleaned; no stray parentheses) ========
      const React = window.React;
      const ReactDOM = window.ReactDOM;
      const { HashRouter, Routes, Route, Link, useNavigate } = window.ReactRouterDOM;
      const API = window.__API_BASE__ ?? "";

      function Card(p){ return React.createElement('div',{className:'a-card',style:p.style},p.children); }
      function Button({variant='dark',style,onClick,children}){
        const cls = variant==='dark'?'btn btn-dark':variant==='mid'?'btn btn-mid':'btn btn-ghost';
        return React.createElement('button',{className:cls,style,onClick},children);
      }
      function NavBar(){
        return React.createElement('div',{className:'nav'},
          React.createElement(Link,{to:'/'},React.createElement('strong',null,'Visual Craft')),
          React.createElement('div',{style:{marginLeft:'auto',display:'flex',gap:'12px'}},
            React.createElement(Link,{to:'/book'},'Book'),
            React.createElement(Link,{to:'/download'},'Download')
          )
        );
      }
      function Section({title,children}){
        return React.createElement('div',{className:'container'},
          React.createElement('h2',null,title),
          React.createElement(Card,{style:{background:'#fff',border:'1px solid #e5e5e5'}},children)
        );
      }

      const steps = ['Type','Package','Address','Time','Review'];
      const listingTypes = [
        { key:'residential', label:'Residential Listing', img:'/public/images/residential.jpg' },
        { key:'land',        label:'Land Listing',        img:'/public/images/land.jpg' },
        { key:'commercial',  label:'Commercial Listing',  img:'/public/images/commercial.jpg' },
      ];
      const packages = [
        { key:'silver',   label:'Silver Package',   minutes:60,  desc:'Professional photography of interior and exterior of property.' },
        { key:'gold',     label:'Gold Package',     minutes:90,  desc:'Professional photography of interior and exterior of property, and a Video Walkthrough Tour.' },
        { key:'platinum', label:'Platinum Package', minutes:120, desc:'Professional photography of interior and exterior of property. A Video Walkthrough Tour, Drone Video and Photography, as well as floor plan illustrations.' },
      ];

      function Stepper({current}){
        const pills = steps.map((s,i)=>React.createElement('div',{
          key:s,
          style:{
            padding:'8px 12px',borderRadius:'999px',border:'1px solid #e5e5e5',
            background:i===current?'#111':i<current?'#4d4d4d':'#fff',
            color:(i===current||i<current)?'#fff':'#111'
          }
        },s));
        return React.createElement('div',{style:{display:'flex',gap:'12px',justifyContent:'center',margin:'16px auto 8px',maxWidth:'720px'}},pills);
      }

      function Splash(){
        return React.createElement('div',{className:'splash-bg'},
          React.createElement('div',{className:'center-card'},
            React.createElement(Card,null,
              React.createElement('h1',null,'Visual Craft Photography'),
              React.createElement('p',null,'Sign in or create an account'),
              React.createElement('div',{className:'grid'},
                React.createElement(Button,{variant:'dark'},'Log in'),
                React.createElement(Button,{variant:'mid'},'Create account')
              ),
              React.createElement('div',{className:'pill-share'},
                React.createElement('div',null,
                  React.createElement('a',{href:'#/download',style:{color:'#111',textDecoration:'none'}},'Share')
                )
              )
            )
          )
        );
      }

      function BookingFlow(){
        const nav = useNavigate();
        const [step,setStep] = React.useState(0);
        const [form,setForm] = React.useState({ listingType:null, pkg:null, place:null, slot:null });
        const [query,setQuery] = React.useState('');
        const mockPlaces = React.useMemo(()=>[
          { label:'4718 Lake Park Dr. Unit #2 Johnson City, TN 37615', lat:36.3671, lng:-82.3709 },
          { label:'123 Main St, Asheville, NC', lat:35.5951, lng:-82.5515 }
        ],[]);
        const [results,setResults] = React.useState(mockPlaces);

        React.useEffect(()=>{
          if (!(window.google?.maps?.places)){
            setResults(mockPlaces.filter(p => p.label.toLowerCase().includes(query.toLowerCase())));
          }
        },[query,mockPlaces]);

        const [slots,setSlots] = React.useState({ list:[], duration:60 });
        React.useEffect(()=>{
          (async()=>{
            if(!form.pkg) return;
            try{
              const r = await fetch(API + '/api/availability',{
                method:'POST',headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ pkg: form.pkg.label, days: 14 })
              });
              const j = await r.json();
              setSlots({ list: j.slots || [], duration: j.durationMin || (form.pkg?.minutes||60) });
            }catch{
              setSlots({ list:[], duration: form.pkg?.minutes || 60 });
            }
          })();
        },[form.pkg]);

        function TypeStep(){
          const tiles = listingTypes.map(t=>React.createElement('button',{
            key:t.key,onClick:()=>{ setForm(f=>({...f,listingType:t.key})); setStep(1); },className:'tile'
          },
            React.createElement('img',{src:t.img,alt:t.label}),
            React.createElement('h3',null,t.label)
          ));
          return Section({title:'Choose a Listing Type',children:React.createElement('div',{className:'grid'},tiles)});
        }

        function PackageStep(){
          const cards = packages.map(p=>React.createElement('button',{
            key:p.key,onClick:()=>{ setForm(f=>({...f,pkg:p})); setStep(2); },
            style:{textAlign:'left',padding:'16px',borderRadius:'12px',border:'1px solid #e5e5e5',background:'#fff'}
          },
            React.createElement('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',gap:'8px'}},
              React.createElement('div',null,
                React.createElement('div',{style:{fontSize:'18px'}},p.label),
                React.createElement('div',{style:{color:'#4d4d4d',marginTop:'4px'}},p.desc)
              ),
              React.createElement('div',{style:{fontSize:'14px',color:'#4d4d4d'}}, p.minutes + ' min')
            )
          ));
          return Section({title:'Select a Package',children:React.createElement('div',{className:'grid'},cards)});
        }

        function AddressStep(){
          const items = results.map(r=>React.createElement('button',{
            key:r.label,onClick:()=>{ setForm(f=>({...f,place:r})); setStep(3); },
            style:{textAlign:'left',padding:'12px',borderRadius:'12px',border:'1px solid #e5e5e5',background:'#fff'}
          },r.label));
          return Section({
            title:'Property Address',
            children:React.createElement('div',{className:'grid',style:{gap:'16px'}},
              React.createElement('input',{id:'addr-input',placeholder:'Search address…',value:query,onChange:e=>setQuery(e.target.value),
                style:{padding:'14px',borderRadius:'12px',border:'1px solid #e5e5e5'}}),
              React.createElement('div',{className:'grid'},items)
            )
          });
        }

        function TimeStep(){
          if (slots.list.length===0){
            return Section({title:'Select a Time',children:React.createElement('div',{style:{color:'#4d4d4d'}},'No available times (try another day).')});
          }
          const btns = slots.list.map(iso=>{
            const label = new Date(iso).toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
            return React.createElement('button',{
              key:iso,onClick:()=>{ setForm(f=>({...f,slot:{startISO:iso}})); setStep(4); },
              style:{textAlign:'left',padding:'14px',borderRadius:'12px',border:'1px solid #e5e5e5',background:'#fff',display:'flex',justifyContent:'space-between'}
            },
              React.createElement('span',null,label),
              React.createElement('span',{style:{color:'#4d4d4d'}}, slots.duration + ' min')
            );
          });
          return Section({title:'Select a Time',children:React.createElement('div',{className:'grid'},btns)});
        }

        function ReviewStep(){
          const typeLabel = (listingTypes.find(t=>t.key===form.listingType)||{}).label || '';
          return Section({title:'Review & Confirm',children:
            React.createElement('div',{className:'grid'},
              React.createElement('div',null,React.createElement('strong',null,'Listing Type: '),typeLabel),
              React.createElement('div',null,React.createElement('strong',null,'Package: '),form.pkg?.label||''),
              React.createElement('div',null,React.createElement('strong',null,'Address: '),form.place?.label||''),
              React.createElement('div',null,React.createElement('strong',null,'Date & Time: '),new Date(form.slot?.startISO||Date.now()).toLocaleString()),
              React.createElement('div',{style:{display:'flex',gap:'12px',marginTop:'8px'}},
                React.createElement(Button,{variant:'dark',onClick:async()=>{
                  const r = await fetch(API + '/api/book',{
                    method:'POST',headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({
                      listingType:typeLabel,pkg:form.pkg?.label,address:form.place?.label,
                      lat:form.place?.lat,lng:form.place?.lng,startISO:form.slot?.startISO,
                      name:'Client',email:'client@example.com',phone:'555-555-5555',notes:''
                    })
                  });
                  const j = await r.json();
                  if (j.ok && j.code) window.location.hash = '#/confirm/' + j.code;
                  else alert('Booking failed');
                }},'Confirm Appointment'),
                React.createElement(Button,{variant:'mid',onClick:()=>setStep(3)},'Back')
              )
            )
          });
        }

        const page =
          step===0 ? TypeStep() :
          step===1 ? PackageStep() :
          step===2 ? AddressStep() :
          step===3 ? TimeStep() : ReviewStep();

        return React.createElement('div',{style:{paddingBottom:'32px'}},
          React.createElement(Stepper,{current:step}),
          page
        );
      }

      function ConfirmPage(){
        const code = window.location.hash.split('/').pop() || '';
        return Section({title:'Appointment Confirmed',children:
          React.createElement('div',{className:'center'},
            React.createElement('div',{style:{fontSize:'28px',marginBottom:'8px'}},'Confirmation #'),
            React.createElement('div',{style:{fontSize:'22px',marginBottom:'16px'}},code),
            React.createElement('div',{style:{color:'#4d4d4d',margin:'0 auto 16px',maxWidth:'560px',lineHeight:1.35}},
              'A confirmation email with an .ics invite will be sent. It includes a one-tap Reschedule link.'),
            React.createElement('div',{style:{display:'flex',justifyContent:'center',gap:'12px',flexWrap:'wrap',maxWidth:'560px',margin:'0 auto'}},
              React.createElement(Button,{variant:'mid',style:{minWidth:'260px'}},'Add to Calendar (ICS)'),
              React.createElement(Button,{variant:'dark',style:{minWidth:'260px'}},'Manage Booking')
            )
          )
        });
      }

      function DownloadPage(){
        return Section({title:'Download / Install',children:
          React.createElement('div',{className:'grid'},
            React.createElement('div',null,React.createElement('strong',null,'PWA (Web App): '),'On iPhone Safari: Share → Add to Home Screen. On Android Chrome: ⋮ → Install App.'),
            React.createElement('div',null,React.createElement('strong',null,'App Icon: '),'Placeholder icons in /public/icons/. Replace later.'),
            React.createElement('div',{style:{display:'flex',gap:'12px',alignItems:'center',flexWrap:'wrap'}},
              React.createElement('img',{alt:'Icon 192',src:'/public/icons/icon-192.png',style:{width:'64px',height:'64px',borderRadius:'14px',border:'1px solid #e5e5e5'}}),
              React.createElement('img',{alt:'Icon 512',src:'/public/icons/icon-512.png',style:{width:'72px',height:'72px',borderRadius:'16px',border:'1px solid #e5e5e5'}})
            ),
            React.createElement('div',null,React.createElement('a',{href:'#/'},'Back to login'))
          )
        });
      }

      function App(){
        return React.createElement(HashRouter,null,
          React.createElement(NavBar,null),
          React.createElement(Routes,null,
            React.createElement(Route,{path:'/',             element:React.createElement(Splash)}),
            React.createElement(Route,{path:'/book',         element:React.createElement(BookingFlow)}),
            React.createElement(Route,{path:'/confirm/:code',element:React.createElement(ConfirmPage)}),
            React.createElement(Route,{path:'/download',     element:React.createElement(DownloadPage)})
          )
        );
      }

      // Diagnostics
      const diag = document.getElementById('diag');
      diag.innerHTML =
        `<b>React:</b> ${window.React?' <span class="ok">OK</span>':'<span class="bad">MISSING</span>'} &nbsp;`+
        `<b>ReactDOM:</b> ${window.ReactDOM?' <span class="ok">OK</span>':'<span class="bad">MISSING</span>'} &nbsp;`+
        `<b>Router:</b> ${window.ReactRouterDOM?' <span class="ok">OK</span>':'<span class="bad">MISSING</span>'} &nbsp;`+
        `<b>Image:</b> <a href="/public/images/splash-bg.jpg" target="_blank">open</a> &nbsp;`+
        `<b>Health:</b> <a href="/api/health" target="_blank">check</a>`;

      // Mount
      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(()=>{});
        });
      }
    </script>
  </body>
</html>
